name: Python CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy pandas scikit-learn matplotlib seaborn nbformat

      - name: Python syntax check
        run: |
          python -m py_compile generate_house_dataset.py record_experiment_results.py export_results_visuals.py tmp_ensemble_debug.py

      - name: Validate notebook JSON
        run: |
          python - <<'PY'
          from pathlib import Path
          import nbformat

          notebook_dir = Path("notebooks")
          notebooks = sorted(notebook_dir.glob("*.ipynb"))
          if not notebooks:
            raise SystemExit("No notebooks found in notebooks/")

          for nb_path in notebooks:
            nbformat.read(nb_path, as_version=4)
            print(f"OK: {nb_path}")
          PY

      - name: Smoke test dataset generator
        run: |
          python generate_house_dataset.py --out-dir tmp/ci_dataset --train-size 30 --cv-size 9 --test-size 9 --seed 7
          test -f tmp/ci_dataset/house_buy_train.csv
          test -f tmp/ci_dataset/house_buy_cv.csv
          test -f tmp/ci_dataset/house_buy_test.csv
          test -f tmp/ci_dataset/house_buy_full_dataset.csv
